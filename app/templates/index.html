<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Atomic Habits</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/index.css') }}">
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
</head>
<body>
    <header class="text-center p-6 mb-6">
        <h1 class="text-4xl font-bold">Habit Tracker</h1>
    </header>

    <main class="max-w-5xl mx-auto p-6 bg-opacity-10 rounded shadow-lg mt-6 text-center">
                    <!-- Toggle Form Visibility Button -->
                    <button class="toggle-button" onclick="toggleForm()">Add New Habit</button>

        <!-- Add Habit Form -->
        <div class="form-container" id="habitForm">
            <h3 class="text-xl font-bold mb-4">Add a New Habit</h3>
            <form method="POST">
                <input type="text" name="habit_name" placeholder="Habit Name" required>
                <button type="submit">Add Habit</button>
            </form>
        </div>
        <!-- Navigation Arrows -->
        <div class="navigation">
            <a href="?week_offset={{ week_offset - 1 }}"><i class="fas fa-arrow-left"></i></a>
            <a href="?week_offset={{ week_offset + 1 }}"><i class="fas fa-arrow-right"></i></a>
        </div>

        <!-- Habits Table -->
        <table class="overflow-hidden rounded-lg">
            <thead>
                <tr>
                    <th>Options</th>
                    <th>Habit</th>
                    {% for day in week_dates %}
                    <th>{{ day.strftime('%a %d') }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for habit, statuses in habit_status_dict.items() %}
                <tr>
                    <td>
                        <form method="POST" action="{{ url_for('delete_habit', habit_id=habit.id) }}" style="display:inline;">
                            <button type="submit" class="delete-button">Delete</button>
                        </form>
                    </td>
                    <td>{{ habit.name }}</td>
                    {% for status in statuses %}
                    <td>
                        <input type="checkbox" data-habit-id="{{ habit.id }}" data-date="{{ status.date }}" {% if status.completed %}checked{% endif %}>
                    </td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <nav class="mt-4">
            <a href="/analysis" class="analysis-button">View Analysis</a>
        </nav>
    </main>

    <script>
        function toggleForm() {
            const formContainer = document.getElementById('habitForm');
            formContainer.style.display = formContainer.style.display === 'none' || formContainer.style.display === '' ? 'block' : 'none';
        }

        document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
            checkbox.addEventListener('change', () => {
                const habitId = checkbox.getAttribute('data-habit-id');
                const date = checkbox.getAttribute('data-date');
                const completed = checkbox.checked;

                // Send an AJAX request to update the server
                fetch('/update_status', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ habit_id: habitId, date: date, completed: completed })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log('Status updated successfully');
                    }
                })
                .catch(error => console.error('Error updating status:', error));
            });
        });


if ('serviceWorker' in navigator) {
    window.addEventListener('load', function() {
        navigator.serviceWorker.register('/static/service-worker.js')
        .then(function(registration) {
            console.log('Service Worker registered with scope:', registration.scope);
        })
        .catch(function(error) {
            console.error('Service Worker registration failed:', error);
        });
    });
}
    </script>
</body>
</html>
